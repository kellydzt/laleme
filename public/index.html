<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Laleme (Êãâ‰∫Ü‰πà)</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

    <!-- Fonts: Plus Jakarta Sans for modern geometric feel -->
    <!-- Fonts: System Default for offline capability in China -->
    <!-- Removed Google Fonts: Plus Jakarta Sans -->

    <link rel="stylesheet" href="style.css">

    <!-- Phosphor Icons (Local) -->
    <link rel="stylesheet" href="lib/phosphor/src/regular/style.css">
    <link rel="stylesheet" href="lib/phosphor/src/bold/style.css">
    <link rel="stylesheet" href="lib/phosphor/src/fill/style.css">
    <link rel="stylesheet" href="lib/phosphor/src/duotone/style.css">
</head>

<body>
    <div class="bento-container">
        <!-- Header Card -->
        <header class="bento-card header-card">
            <div class="logo-area">
                <i class="ph-fill ph-toilet-paper"></i>
                <h1 class="app-title" data-i18n="app_title">Laleme</h1>
            </div>

            <!-- Persona Switcher -->
            <div id="persona-switcher" class="persona-switcher">
                <div class="current-persona">
                    <i class="ph-fill ph-user-circle"></i>
                    <span id="current-persona-name">Guest</span>
                </div>
                <!-- Dropdown -->
                <div id="persona-dropdown" class="persona-dropdown hidden">
                    <div class="persona-list" id="persona-list">
                        <!-- Populated by JS -->
                    </div>

                    <a href="settings.html" class="persona-option"
                        style="text-decoration:none; color:inherit; border-top:1px solid rgba(255,255,255,0.05); margin-top:4px;">
                        <i class="ph-bold ph-gear"></i> <span data-i18n="menu_settings">Settings</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Stats Row -->
        <div class="bento-card stat-card blue-accent">
            <span class="stat-label" data-i18n="stat_today">Today</span>
            <span class="stat-value" id="today-count">0</span>
            <i class="ph-duotone ph-clock stat-icon"></i>
        </div>
        <div class="bento-card stat-card purple-accent" onclick="window.location.href='trends.html'"
            style="cursor:pointer; position: relative;">
            <span class="stat-label" data-i18n="stat_trends">Trends (7d)</span>
            <span class="stat-value" id="total-count">0</span>
            <i class="ph-duotone ph-chart-line-up stat-icon"></i>
            <div style="font-size:0.7rem; color:rgba(255,255,255,0.4); position:absolute; bottom:12px; right:12px;">
                Click to view ></div>
        </div>

        <!-- Main Action Card -->
        <form id="upload-form" class="bento-card action-card lime-accent"
            onclick="document.getElementById('photo-input').click()">
            <div class="action-content">
                <div class="icon-circle">
                    <i class="ph-fill ph-camera"></i>
                </div>
                <h2 data-i18n="action_log">Log It Now</h2>
                <p data-i18n="action_log_desc">Track your health daily</p>
            </div>
            <input type="file" id="photo-input" name="photo" accept="image/*" capture="environment">
            <input type="hidden" name="stool_type" value="4">
            <input type="hidden" name="color" value="brown">
        </form>

        <!-- Feed Section -->
        <div class="bento-card feed-card">
            <div class="feed-header">
                <h3 data-i18n="recent_history">Recent History</h3>
                <i class="ph-bold ph-caret-right"></i>
            </div>
            <div id="records-list" class="records-list">
                <!-- Records injected here -->
            </div>
        </div>
    </div>

    <!-- AI Overlay -->
    <div id="analysis-overlay" class="overlay hidden">
        <div class="modal-card">
            <div class="modal-header">
                <i class="ph-fill ph-sparkle"></i>
                <h3 data-i18n="ai_insights_title">AI Insights</h3>
            </div>
            <div class="modal-body">
                <p id="analysis-text">Analyzing image data...</p>
            </div>
            <div style="display:flex; gap:10px; margin-top:0px;">
                <button class="close-btn" style="flex:1;" data-i18n="btn_done">Done</button>
                <button class="secondary-btn"
                    style="display:flex; align-items:center; justify-content:center; gap:6px; padding:12px 16px; background:linear-gradient(135deg, rgba(163,230,53,0.2) 0%, rgba(74,222,128,0.2) 100%); border:1px solid rgba(163,230,53,0.3); border-radius:12px; color:#a3e635; font-weight:500; font-size:0.9rem;"
                    onclick="generateShareImage(window.lastAnalysisData, window.lastRecord)">
                    <i class="ph-bold ph-image" style="font-size:1.1rem;"></i>
                    <span data-i18n="btn_gen_image">ÁîüÊàêÂõæÁâá</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Persona Selector Overlay -->
    <!-- Persona Selector Overlay -->
    <div id="persona-selector-overlay" class="overlay hidden">
        <div class="modal-card">

            <div class="modal-header"
                style="justify-content:center; align-items:center; flex-direction:column; gap:8px; border:none; padding-bottom:10px;">
                <h3 style="font-size:1.4rem;">Who is this for?</h3>
                <span class="sub-text">Select the profile for this log</span>
            </div>

            <!-- New Contained Image Preview -->
            <div class="modal-image-container" style="height: 180px; margin-bottom: 20px;">
                <img id="persona-selector-preview" src="" class="detail-img blurred"
                    style="object-fit: cover; height: 100%;">
            </div>

            <div id="persona-selector-grid" class="persona-grid"
                style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:20px; padding:0 10px 20px 10px;">
                <!-- Avatars injected here -->
            </div>

            <button class="close-btn secondary-btn" id="btn-cancel-upload"
                style="margin-top:10px; background:rgba(255,255,255,0.1);">Cancel</button>
        </div>
    </div>

    <!-- Data Dashboard Overlay -->
    <div id="data-dashboard-overlay" class="overlay hidden">
        <div class="modal-card dashboard-card">
            <div class="modal-header">
                <h3 data-i18n="log_details_title">Log Details</h3>
                <span class="sub-text" data-i18n="log_analyzing_subtitle">While we analyze...</span>
            </div>
            <div class="dashboard-body">
                <!-- 1. Effort -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_straining">Straining / Effort</h4>
                    <div class="effort-selector" id="effort-selector">
                        <div class="effort-option" data-value="1">
                            <span class="emoji">üòå</span>
                            <span class="label" data-i18n="val_easy">Easy</span>
                        </div>
                        <div class="effort-option" data-value="2">
                            <span class="emoji">üòê</span>
                            <span class="label" data-i18n="val_normal">Normal</span>
                        </div>
                        <div class="effort-option" data-value="3">
                            <span class="emoji">üò£</span>
                            <span class="label" data-i18n="val_hard">Hard</span>
                        </div>
                        <div class="effort-option" data-value="4">
                            <span class="emoji">ü•µ</span>
                            <span class="label" data-i18n="val_blocked">Blocked</span>
                        </div>
                    </div>
                </section>

                <!-- 1.5 Smell -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_smell">Smell</h4>
                    <div class="effort-selector" id="smell-selector">
                        <div class="effort-option" data-value="Normal">
                            <span class="emoji">üçÉ</span>
                            <span class="label" data-i18n="val_smell_normal">Normal</span>
                        </div>
                        <div class="effort-option" data-value="Strong">
                            <span class="emoji">ü§¢</span>
                            <span class="label" data-i18n="val_smell_strong">Strong</span>
                        </div>
                        <div class="effort-option" data-value="Sour">
                            <span class="emoji">üçã</span>
                            <span class="label" data-i18n="val_smell_sour">Sour</span>
                        </div>
                        <div class="effort-option" data-value="Unbearable">
                            <span class="emoji">‚ò†Ô∏è</span>
                            <span class="label" data-i18n="val_smell_unbearable">Unbearable</span>
                        </div>
                    </div>
                </section>

                <!-- 2. Sensation -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_sensation">Evacuation Sensation</h4>
                    <div class="effort-selector" id="sensation-selector">
                        <div class="effort-option selected" data-value="complete">
                            <span class="emoji">üòå</span>
                            <span class="label" data-i18n="val_complete">Complete</span>
                        </div>
                        <div class="effort-option" data-value="incomplete">
                            <span class="emoji">üò£</span>
                            <span class="label" data-i18n="val_incomplete">Incomplete</span>
                        </div>
                    </div>
                </section>

                <!-- 3. Symptoms -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_symptoms">Symptoms</h4>
                    <div class="tag-cloud" id="symptoms-tags">
                        <span class="tag" data-value="pain" data-i18n="tag_pain">#Pain</span>
                        <span class="tag" data-value="bloating" data-i18n="tag_bloating">#Bloating</span>
                        <span class="tag" data-value="burning" data-i18n="tag_burning">#Burning</span>
                        <span class="tag" data-value="nausea" data-i18n="tag_nausea">#Nausea</span>
                        <span class="tag" data-value="bleeding" data-i18n="tag_bleeding">#Bleeding</span>
                    </div>
                </section>

                <!-- 4. Triggers -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_triggers">Triggers</h4>
                    <div class="icon-grid" id="triggers-grid">
                        <div class="icon-item" data-value="coffee">
                            <i class="ph-fill ph-coffee"></i>
                            <span data-i18n="tag_coffee">Coffee</span>
                        </div>
                        <div class="icon-item" data-value="spicy">
                            <i class="ph-fill ph-fire"></i>
                            <span data-i18n="tag_spicy">Spicy</span>
                        </div>
                        <div class="icon-item" data-value="dairy">
                            <i class="ph-fill ph-cheese"></i>
                            <span data-i18n="tag_dairy">Dairy</span>
                        </div>
                        <div class="icon-item" data-value="alcohol">
                            <i class="ph-fill ph-beer-bottle"></i>
                            <span data-i18n="tag_alcohol">Alcohol</span>
                        </div>
                        <div class="icon-item" data-value="meds">
                            <i class="ph-fill ph-pill"></i>
                            <span data-i18n="tag_meds">Meds</span>
                        </div>
                    </div>
                </section>

                <!-- 5. Context -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_context">Context</h4>
                    <div class="context-selector" id="context-selector">
                        <button class="context-btn" data-value="home"><i class="ph-fill ph-house"></i> <span
                                data-i18n="tag_home">Home</span></button>
                        <button class="context-btn" data-value="work"><i class="ph-fill ph-briefcase"></i> <span
                                data-i18n="tag_work">Work</span></button>
                        <button class="context-btn" data-value="hotel"><i class="ph-fill ph-bed"></i> <span
                                data-i18n="tag_hotel">Hotel</span></button>
                        <button class="context-btn" data-value="public"><i class="ph-fill ph-toilet"></i>
                            <span data-i18n="tag_public">Public</span></button>
                    </div>
                </section>

                <!-- 6. Location (Auto) -->
                <section class="dashboard-section">
                    <h4 data-i18n="lbl_location">Location</h4>
                    <div class="location-display"
                        style="display:flex; align-items:center; justify-content:space-between; background:rgba(255,255,255,0.05); padding:12px 16px; border-radius:12px;">
                        <span id="location-city-text"
                            style="font-size:0.95rem; color:var(--text-muted); cursor:pointer; display:flex; align-items:center; gap:8px;">
                            <i class="ph-bold ph-navigation-arrow"></i> <span data-i18n="btn_locate">Auto-locate</span>
                        </span>
                    </div>
                    <div style="font-size:0.75rem; color:rgba(255,255,255,0.4); margin-top:8px;"
                        data-i18n="loc_disclaimer">* Only city level is recorded</div>
                </section>
            </div>
            <button id="save-details-btn" class="primary-btn" data-i18n="btn_save_analysis">Save & View
                Analysis</button>
        </div>
    </div>

    <!-- PERSONA WIZARD OVERLAY -->
    <div id="persona-wizard-overlay" class="overlay hidden" style="z-index: 2000;">
        <div class="modal-card">
            <div class="modal-header">
                <i class="ph-fill ph-user-plus"></i>
                <h3 data-i18n="create_profile_title">Create Profile</h3>
            </div>
            <div class="modal-body" style="padding: 20px 0;">

                <!-- STEP 1: BASICS -->
                <div id="wizard-step-1" class="wizard-step">
                    <div class="input-group">
                        <label data-i18n="lbl_nickname">Nickname</label>
                        <input type="text" id="persona-nickname" placeholder="e.g. Baby Joe" class="text-input">
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_dob">Date of Birth</label>
                        <input type="date" id="persona-dob" class="text-input">
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_gender">Gender</label>
                        <div class="segment-control" id="gender-control">
                            <div class="segment-option selected" data-value="male" data-i18n="val_boy">Boy</div>
                            <div class="segment-option" data-value="female" data-i18n="val_girl">Girl</div>
                        </div>
                    </div>
                    <button class="primary-btn" id="btn-wizard-next"><span data-i18n="btn_next">Next</span> <i
                            class="ph-bold ph-arrow-right"></i></button>
                </div>

                <!-- STEP 2: BABY CONTEXT -->
                <div id="wizard-step-baby" class="wizard-step hidden">
                    <div class="info-box">
                        <i class="ph-fill ph-baby"></i>
                        <span data-i18n="info_baby">Analyzed as <b>Baby (< 1y)</b></span>
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_feeding">Feeding Method (Crucial)</label>
                        <div class="grid-options" id="baby-feeding-options">
                            <div class="grid-option" data-value="Breast" data-i18n="val_breast">ü§± Breast</div>
                            <div class="grid-option" data-value="Formula" data-i18n="val_bottle">üçº Formula</div>
                            <div class="grid-option" data-value="Mix" data-i18n="val_mixed">üß™ Mix</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_stage">Current Stage</label>
                        <div class="grid-options" id="baby-stage-options">
                            <div class="grid-option" data-value="New" data-i18n="val_newborn">üë∂ New</div>
                            <div class="grid-option" data-value="Solid" data-i18n="val_solids">ü•ï Solids</div>
                        </div>
                    </div>
                    <button class="primary-btn" id="btn-create-baby" data-i18n="btn_create_profile">Create
                        Profile</button>
                </div>

                <!-- STEP 2: ADULT CONTEXT -->
                <div id="wizard-step-adult" class="wizard-step hidden">
                    <div class="info-box adult">
                        <i class="ph-fill ph-user"></i>
                        <span data-i18n="info_adult">Analyzed as <b>Adult/Teen</b></span>
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_conditions">Health Conditions (Optional)</label>
                        <div class="tag-cloud" id="adult-health-tags">
                            <span class="tag" data-value="IBS" data-i18n="val_ibs">IBS</span>
                            <span class="tag" data-value="Lactose" data-i18n="val_lactose">Lactose Intolerant</span>
                            <span class="tag" data-value="NoGallbladder" data-i18n="val_no_gallbladder">No
                                Gallbladder</span>
                            <span class="tag" data-value="Constipation" data-i18n="val_constipation">Constipation</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label data-i18n="lbl_meds">Medications</label>
                        <div class="tag-cloud" id="adult-meds-tags">
                            <span class="tag" data-value="Iron" data-i18n="val_iron">Iron Supps</span>
                            <span class="tag" data-value="Antibiotics" data-i18n="val_antibiotics">Antibiotics</span>
                        </div>
                    </div>
                    <button class="primary-btn" id="btn-create-adult" data-i18n="btn_create_profile">Create
                        Profile</button>
                </div>

            </div>
        </div>
    </div>

    <!-- External Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="app.js"></script>

    <!-- Hidden Share Template (Fixed Width for Rendering) -->
    <div id="share-template-container" style="position:fixed; left:-9999px; top:0; z-index:-1;">
        <div id="share-card"
            style="width: 480px; background: #1a1a1a; padding: 40px; color: #fff; font-family: 'Inter', sans-serif; border-radius: 24px; box-sizing: border-box; overflow: hidden; position: relative;">

            <!-- Deco Background -->
            <div
                style="position:absolute; top:-50%; right:-50%; width:100%; height:100%; background:radial-gradient(circle, rgba(163,230,53,0.1) 0%, transparent 70%); filter:blur(40px);">
            </div>

            <!-- Header -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; position:relative;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:24px;">‚ú®</span>
                    <span style="font-size:20px; font-weight:700; letter-spacing:-0.5px;">LaLeMe</span>
                </div>
                <div id="share-date" style="font-size:14px; opacity:0.5; font-family:monospace;">--/--</div>
            </div>

            <!-- Score Section -->
            <!-- Score Section -->
            <div
                style="text-align:center; margin-bottom:35px; display:flex; flex-direction:column; align-items:center; position:relative;">
                <div
                    style="width:120px; height:120px; border-radius:50%; background:rgba(163,230,53,0.1); border:2px solid rgba(163,230,53,0.5); display:flex; align-items:center; justify-content:center; margin-bottom:15px; box-shadow:0 0 50px rgba(163,230,53,0.2);">
                    <div id="share-score"
                        style="font-size:72px; font-weight:800; line-height:1; color:#a3e635; text-shadow: 0 0 20px rgba(163,230,53,0.4);">
                        B</div>
                </div>
                <div id="share-summary"
                    style="font-size:18px; opacity:0.9; padding:0 20px; line-height:1.4; font-weight:600;">
                    Excellent!</div>
            </div>

            <!-- Bristol Type (moved above Grid) -->
            <div
                style="background:rgba(255,255,255,0.05); padding:20px; border-radius:16px; margin-bottom:20px; position:relative;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <i class="ph-fill ph-rows" style="opacity:0.6;"></i>
                    <span style="font-size:14px; opacity:0.6; text-transform:uppercase; letter-spacing:1px;">Bristol
                        Type</span>
                </div>
                <div id="share-bristol-title" style="font-size:18px; font-weight:600; margin-bottom:4px;">Type 3</div>
                <div id="share-bristol-desc" style="font-size:14px; opacity:0.7; font-style:italic;">Sausage shaped,
                    cracks on surface</div>
            </div>

            <!-- Grid (Effort, Sensation, Smell only - no privacy data) -->
            <div id="share-grid"
                style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-bottom:30px; position:relative;">
                <!-- Filled by JS -->
            </div>

            <!-- Footer -->
            <div
                style="text-align:center; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; position:relative;">
                <div style="font-size:14px; opacity:0.6; margin-bottom:4px;">ËÇ†ÈÅìÂú®‚ÄúË∑ëË∑Ø‚ÄùÔºåÁªÜÂöºÊÖ¢ÂíΩÂëÄ</div>
                <div style="font-size:10px; opacity:0.3; letter-spacing:2px;">POWERED BY LALEME</div>
            </div>
        </div>
    </div>

    <!-- Share Modal (Preview Result) -->
    <div id="share-modal" class="overlay hidden" style="z-index: 10001; background: rgba(0,0,0,0.95);">
        <div
            style="display:flex; flex-direction:column; align-items:center; width:100%; height:100%; padding:20px; box-sizing:border-box; justify-content:center;">
            <div style="margin-bottom:20px; color:#fff; font-size:16px; font-weight:500; opacity:0.8;"
                data-i18n="share_tip">ÂõæÁâáÂ∑≤ÁîüÊàêÔºåÂèØÈïøÊåâ‰øùÂ≠òÊàñÁÇπÂáª‰∏ãËΩΩ</div>
            <img id="share-result-img" src=""
                style="max-width:100%; max-height:70vh; border-radius:16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="display:flex; gap:12px; margin-top:24px;">
                <button class="primary-btn"
                    style="padding:12px 24px; background:linear-gradient(135deg, #a3e635 0%, #4ade80 100%); color:#000; font-weight:600; border-radius:100px; display:flex; align-items:center; gap:8px;"
                    onclick="downloadShareImage()">
                    <i class="ph-bold ph-download-simple"></i>
                    <span data-i18n="btn_download">‰∏ãËΩΩÂõæÁâá</span>
                </button>
                <button class="secondary-btn"
                    style="padding:12px 24px; background:rgba(255,255,255,0.1); border-radius:100px;"
                    onclick="document.getElementById('share-modal').classList.add('hidden')"
                    data-i18n="btn_close">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
</body>

</html>